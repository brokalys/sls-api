service: sls-api

provider:
  name: aws
  region: eu-west-1
  runtime: nodejs12.x
  stage: ${opt:stage, 'dev'}
  cfLogs: true
  logRetentionInDays: 7
  versionFunctions: false
  timeout: 20
  environment:
    DB_HOST: ${file(serverless.env.yml):DB_HOST, env:DB_HOST}
    DB_DATABASE: ${file(serverless.env.yml):DB_DATABASE, env:DB_DATABASE}
    DB_USERNAME: ${file(serverless.env.yml):DB_USERNAME, env:DB_USERNAME}
    DB_PASSWORD: ${file(serverless.env.yml):DB_PASSWORD, env:DB_PASSWORD}
    DB_PINGER_DATABASE: ${file(serverless.env.yml):DB_PINGER_DATABASE, env:DB_PINGER_DATABASE}
    DB_CACHE_DATABASE: ${file(serverless.env.yml):DB_CACHE_DATABASE, env:DB_CACHE_DATABASE}
    GMAPS_KEY: ${file(serverless.env.yml):GMAPS_KEY, env:GMAPS_KEY}
    STAGE: ${opt:stage, 'dev'}

functions:
  graphql:
    name: ${self:provider.stage}-GraphQLApi
    description: GraphQL API of Brokalys.
    handler: src/handler.graphqlHandler
    events:
      - http:
          path: /
          method: post
          cors: true
      - http:
          path: /
          method: get

plugins:
  - serverless-webpack
  - serverless-domain-manager
  - serverless-plugin-aws-alerts
  - serverless-offline

custom:
  customDomain:
    domainName: api.brokalys.com
    stage: prod
    certificateName: '*.brokalys.com'
    createRoute53Record: true
    endpointType: edge
    basePath: '/'

  alerts:
    stages:
      - prod
    topics:
      alarm:
        topic: ${self:provider.stage}-${self:service}-alerts-alarm
        notifications:
          - protocol: email
            endpoint: matiss@brokalys.com
      ok:
        topic: ${self:provider.stage}-${self:service}-alerts-ok
        notifications:
          - protocol: email
            endpoint: matiss@brokalys.com
    definitions:
      functionErrors:
        description: 'SLS API has an error that needs to be fixed'
        treatMissingData: notBreaching
      functionInvocations:
        threshold: 300
        period: 86400 # 1 day
        treatMissingData: notBreaching
    alarms:
      - functionErrors
      - functionInvocations

  serverless-offline:
    useChildProcesses: true
  webpack:
    includeModules: true
    packager: yarn
